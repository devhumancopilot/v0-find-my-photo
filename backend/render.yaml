services:
  # Backend API Server
  - type: web
    name: findmyphoto-backend
    runtime: node
    region: oregon
    plan: free
    branch: main
    rootDir: backend
    buildCommand: |
      export NODE_OPTIONS="--max-old-space-size=350"
      pnpm install --frozen-lockfile
      pnpm run build
    startCommand: |
      export NODE_OPTIONS="--max-old-space-size=400"
      pnpm start
    envVars:
      - key: NODE_ENV
        value: production

      # Frontend URL for CORS
      - key: FRONTEND_URL
        sync: false  # Add in dashboard

      # Supabase
      - key: NEXT_PUBLIC_SUPABASE_URL
        sync: false
      - key: NEXT_PUBLIC_SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false

      # Google OAuth
      - key: NEXT_PUBLIC_GOOGLE_CLIENT_ID
        sync: false
      - key: GOOGLE_CLIENT_SECRET
        sync: false

      # OpenAI
      - key: OPENAI_API_KEY
        sync: false

      # Embedding Configuration
      - key: EMBEDDING_PROVIDER
        value: huggingface
      - key: VARIABLE_EMBEDDING_DIMENSIONS
        value: true
      - key: CLIP_SERVICE_URL
        sync: false
      - key: CLIP_API_KEY
        sync: false

      # Photo Search
      - key: PHOTO_SEARCH_MIN_SIMILARITY
        value: 0.4
      - key: STORE_BASE64_IN_DB
        value: false

      # Vision Reasoning (Can be higher on backend!)
      - key: ENABLE_VISION_RERANKING
        value: true
      - key: VISION_MAX_PHOTOS
        value: 30
      - key: VISION_MIN_CONFIDENCE
        value: 60
      - key: VISION_RERANKING_WEIGHT
        value: 0.4

      # CLIP Re-ranking
      - key: CLIP_MIN_SCORE
        value: 0.20
      - key: CLIP_REFERENCE_WEIGHT
        value: 0.5
      - key: CLIP_NUM_REFERENCES
        value: 3

    healthCheckPath: /
    autoDeploy: true
