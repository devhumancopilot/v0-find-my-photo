services:
  # Backend API Server
  - type: web
    name: v0-find-my-photo-backend
    runtime: node
    region: oregon
    plan: free
    branch: main
    rootDir: backend
    buildCommand: |
      export NODE_OPTIONS="--max-old-space-size=350"
      pnpm install
      pnpm run build
    startCommand: |
      export NODE_OPTIONS="--max-old-space-size=400"
      pnpm start
    envVars:
      - key: NODE_ENV
        value: production
      - key: FRONTEND_URL
        value: https://v0-find-my-photo-v2.onrender.com
      - key: NEXT_PUBLIC_SUPABASE_URL
        sync: false
      - key: NEXT_PUBLIC_SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: NEXT_PUBLIC_GOOGLE_CLIENT_ID
        sync: false
      - key: GOOGLE_CLIENT_SECRET
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: EMBEDDING_PROVIDER
        value: huggingface
      - key: CLIP_SERVICE_URL
        sync: false
      - key: ENABLE_VISION_RERANKING
        value: true
      - key: VISION_MAX_PHOTOS
        value: 30
    healthCheckPath: /
    autoDeploy: true

  # Frontend Web App
  - type: web
    name: v0-find-my-photo-v2
    runtime: node
    region: oregon
    plan: free
    branch: main
    buildCommand: |
      export NODE_OPTIONS="--max-old-space-size=300"
      pnpm install
      pnpm run build
    startCommand: pnpm start
    envVars:
      - key: NODE_ENV
        value: production
      - key: NEXT_PUBLIC_API_URL
        value: https://v0-find-my-photo-backend.onrender.com
      - key: NEXT_PUBLIC_SUPABASE_URL
        sync: false
      - key: NEXT_PUBLIC_SUPABASE_ANON_KEY
        sync: false
      - key: NEXT_PUBLIC_GOOGLE_CLIENT_ID
        sync: false
      - key: NEXT_PUBLIC_GOOGLE_REDIRECT_URI
        sync: false
    healthCheckPath: /
    autoDeploy: true
